apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: openobservefunctions.openobserve.ai
spec:
  group: openobserve.ai
  names:
    kind: OpenObserveFunction
    listKind: OpenObserveFunctionList
    plural: openobservefunctions
    singular: openobservefunction
    shortNames:
    - o2function
    - o2func
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - configRef
            - name
            - function
            properties:
              configRef:
                type: object
                required:
                - name
                properties:
                  name:
                    type: string
                    description: Name of the OpenObserveConfig resource
                  namespace:
                    type: string
                    description: Namespace of the OpenObserveConfig resource (optional)
              name:
                type: string
                pattern: "^[a-zA-Z0-9_-]+$"
                description: Name of the function (must be unique within the organization)
              org:
                type: string
                description: Organization name to create the function in. If not specified, uses the organization from ConfigRef.
              function:
                type: string
                description: VRL function code to transform the data
              numArgs:
                type: integer
                format: int32
                default: 0
                description: Number of arguments the function accepts
              params:
                type: string
                default: "string"
                description: Parameters configuration for the function
              transType:
                type: integer
                format: int32
                default: 0
                description: Transformation type (0 for standard transformation)
              test:
                type: object
                description: Test configuration for the function (optional)
                properties:
                  enabled:
                    type: boolean
                    default: false
                    description: Whether to test the function before creating/updating
                  events:
                    type: array
                    description: Test events to validate the function
                    minItems: 1
                    items:
                      type: object
                      x-kubernetes-preserve-unknown-fields: true
          status:
            type: object
            properties:
              conditions:
                type: array
                items:
                  type: object
                  required:
                  - type
                  - status
                  properties:
                    type:
                      type: string
                      description: Type of condition
                    status:
                      type: string
                      description: Status of the condition (True, False, Unknown)
                    observedGeneration:
                      type: integer
                      format: int64
                      description: Generation observed by the controller
                    lastTransitionTime:
                      type: string
                      format: date-time
                      description: Last time the condition changed
                    reason:
                      type: string
                      description: Reason for the condition change
                    message:
                      type: string
                      description: Human-readable message
              openobserveFunctionId:
                type: string
                description: Function ID in OpenObserve
              organization:
                type: string
                description: Organization where the function was created
              lastSyncTime:
                type: string
                format: date-time
                description: Last time the function was synced with OpenObserve
              observedGeneration:
                type: integer
                format: int64
                description: Generation observed by the controller
              dependencies:
                type: array
                description: List of dependencies for this function
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      description: Dependency ID
                    name:
                      type: string
                      description: Dependency name
              testResults:
                type: object
                description: Results from the last test execution
                properties:
                  success:
                    type: boolean
                    description: Whether the test was successful
                  testedAt:
                    type: string
                    format: date-time
                    description: When the test was executed
                  message:
                    type: string
                    description: Test result message
              lastError:
                type: string
                description: Last error encountered during reconciliation
              deletionRetryCount:
                type: integer
                description: Tracks the number of deletion attempts
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Function
      type: string
      jsonPath: .spec.name
      priority: 0
    - name: Organization
      type: string
      jsonPath: .spec.org
      priority: 1
    - name: Ready
      type: string
      jsonPath: .status.conditions[?(@.type=="Ready")].status
      priority: 0
    - name: Dependencies
      type: integer
      jsonPath: .status.dependencies[*]
      priority: 1
    - name: Test
      type: boolean
      jsonPath: .spec.test.enabled
      priority: 1
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
      priority: 0