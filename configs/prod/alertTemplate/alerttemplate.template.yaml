# ============================================================================
#                 OpenObserve AlertTemplate Resource Template
# ============================================================================
# This template provides a comprehensive guide for creating AlertTemplate resources
# AlertTemplates define reusable notification formats for alerts in OpenObserve
#
# IMPORTANT: OpenObserve only supports two template types:
#   - http: For webhooks (Slack, PagerDuty, custom HTTP endpoints)
#   - email: For email notifications
# ============================================================================

apiVersion: openobserve.ai/v1alpha1
kind: OpenObserveAlertTemplate
metadata:
  # ============================================================================
  # METADATA SECTION
  # ============================================================================

  # Resource name in Kubernetes (must be unique within namespace)
  # Requirements:
  #   - Must be lowercase
  #   - Can contain letters, numbers, and hyphens
  #   - Must start and end with alphanumeric character
  #   - Maximum 253 characters
  name: example-alert-template

  # Kubernetes namespace where this resource will be created
  # Should match the namespace of your OpenObserveConfig
  namespace: o2operator

  # Optional: Labels for organizing and selecting resources
  labels:
    app: openobserve
    environment: production
    team: platform-engineering

  # Optional: Annotations for additional metadata
  annotations:
    description: "Alert template for critical production alerts"
    owner: "platform-team@example.com"

spec:
  # ============================================================================
  # SPEC SECTION - Defines the alert template configuration
  # ============================================================================

  # ----------------------------------------------------------------------------
  # CONFIG REFERENCE (REQUIRED)
  # ----------------------------------------------------------------------------
  # References the OpenObserveConfig containing connection details
  configRef:
    # Name of the OpenObserveConfig resource (REQUIRED)
    # This config must exist and be in Ready state
    name: openobserve-main

    # Namespace of the OpenObserveConfig (OPTIONAL)
    # If not specified, uses the same namespace as this AlertTemplate
    namespace: o2operator

  # ----------------------------------------------------------------------------
  # TEMPLATE IDENTIFICATION
  # ----------------------------------------------------------------------------

  # Unique identifier for the alert template in OpenObserve (REQUIRED)
  # Requirements:
  #   - Must be unique within the organization
  #   - Can only contain: letters, numbers, hyphens, underscores
  #   - Maximum 255 characters
  #   - Cannot be changed after creation (immutable in OpenObserve)
  # Pattern: ^[a-zA-Z0-9_-]+$
  name: "production-critical-alert-v1"

  # Organization name in OpenObserve (OPTIONAL)
  # If not specified, uses the organization from ConfigRef
  # Use this to override the default organization
  org: "production"

  # ----------------------------------------------------------------------------
  # TEMPLATE CONTENT
  # ----------------------------------------------------------------------------

  # Title/Subject of the alert (REQUIRED)
  # Maximum 500 characters
  # Can use template variables (see variable list below)
  # For email type: This becomes the email subject
  # For http type: This is typically used in the webhook payload
  title: "[{severity}] Alert: {alert_name} - {org_name}"

  # Body content of the alert template (REQUIRED)
  # No length limit, can be very large for complex templates
  # Format depends on the type:
  #   - http: Usually JSON format for webhook payloads
  #   - email: Can be HTML or plain text
  #
  # AVAILABLE TEMPLATE VARIABLES (use single curly braces):
  # {alert_name}        - Name of the alert that triggered
  # {alert_id}          - Unique ID of the alert
  # {alert_description} - Description of the alert
  # {severity}          - Severity level (critical, warning, info)
  # {org_name}          - Organization name
  # {stream_name}       - Name of the data stream
  # {stream_type}       - Type of stream (logs, metrics, traces)
  # {triggered_at}      - When the alert was triggered
  # {timestamp}         - Current timestamp
  # {timestamp_iso}     - ISO format timestamp
  # {timestamp_unix}    - Unix timestamp
  # {threshold}         - Alert threshold value
  # {actual_value}      - Actual value that triggered the alert
  # {operator}          - Comparison operator used
  # {env}              - Environment variable
  # {host}             - Host that triggered the alert
  # {service}          - Service name
  # {message}          - Alert message
  # {error_count}      - Number of errors (if applicable)
  # {dashboard_id}     - Related dashboard ID
  # {graph_id}         - Related graph ID
  # Custom fields from your alert context_attributes are also available

  # Example HTTP body for webhooks (Slack, PagerDuty, custom)
  body: |
    {
      "alert_name": "{alert_name}",
      "severity": "{severity}",
      "description": "{alert_description}",
      "organization": "{org_name}",
      "stream": {
        "name": "{stream_name}",
        "type": "{stream_type}"
      },
      "trigger": {
        "timestamp": "{triggered_at}",
        "threshold": "{threshold}",
        "actual_value": "{actual_value}",
        "operator": "{operator}"
      },
      "environment": {
        "env": "{env}",
        "host": "{host}",
        "service": "{service}"
      },
      "message": "{message}",
      "actions": {
        "dashboard_url": "https://openobserve.example.com/dashboard/{dashboard_id}",
        "logs_url": "https://openobserve.example.com/logs?stream={stream_name}&time={timestamp}",
        "runbook_url": "https://wiki.example.com/runbooks/{alert_name}"
      },
      "metadata": {
        "alert_id": "{alert_id}",
        "timestamp_iso": "{timestamp_iso}",
        "timestamp_unix": {timestamp_unix}
      }
    }

  # # HTML email body template
  # body: |
  #   <!DOCTYPE html>
  #   <html lang="en">
  #   <head>
  #       <meta charset="UTF-8">
  #       <meta name="viewport" content="width=device-width, initial-scale=1.0">
  #       <title>Email</title>
  #       <style>
  #           body {
  #               font-family: Arial, sans-serif;
  #               line-height: 1.6;
  #               color: #333;
  #               max-width: 600px;
  #               margin: 0 auto;
  #               padding: 20px;
  #               background-color: #f4f4f4;
  #           }
  #           .email-container {
  #               background-color: #ffffff;
  #               padding: 30px;
  #               border-radius: 8px;
  #               box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  #           }
  #           h1 {
  #               color: #2c3e50;
  #               font-size: 24px;
  #               margin-bottom: 20px;
  #           }
  #           p {
  #               margin-bottom: 15px;
  #           }
  #           .button {
  #               display: inline-block;
  #               padding: 12px 30px;
  #               background-color: #3498db;
  #               color: #ffffff;
  #               text-decoration: none;
  #               border-radius: 5px;
  #               margin: 20px 0;
  #           }
  #           .footer {
  #               margin-top: 30px;
  #               padding-top: 20px;
  #               border-top: 1px solid #e0e0e0;
  #               font-size: 12px;
  #               color: #666;
  #               text-align: center;
  #           }
  #       </style>
  #   </head>
  #   <body>
  #       <div class="email-container">
  #           <h1>Hello!</h1>
            
  #           <p>This is a simple HTML email template. You can customize this content to fit your needs.</p>
            
  #           <p>HTML emails allow you to add formatting, links, and styling to make your messages more engaging and professional.</p>
            
  #           <a href="#" class="button">Click Here</a>
            
  #           <p>Thank you for your time!</p>
            
  #           <p>Best regards,<br>
  #           Your Name</p>
            
  #           <div class="footer">
  #               <p>This is an automated email. Please do not reply to this message.</p>
  #               <p>&copy; 2025 Your Company. All rights reserved.</p>
  #           </div>
  #       </div>
  #   </body>
  #   </html>

  # ----------------------------------------------------------------------------
  # TEMPLATE TYPE (REQUIRED)
  # ----------------------------------------------------------------------------
  # Type of alert template
  # MUST be one of:
  #   - "http"  : For HTTP webhooks (Slack, PagerDuty, custom endpoints)
  #   - "email" : For email notifications
  #
  # NOTE: Even for Slack or PagerDuty, use "http" type with appropriate JSON body
  type: "http"

  # ----------------------------------------------------------------------------
  # DEFAULT TEMPLATE (OPTIONAL)
  # ----------------------------------------------------------------------------
  # Whether this is the default template for this type
  # Only one template per type can be marked as default in an organization
  # Default: false
  isDefault: false

# ============================================================================
# STATUS SECTION (READ-ONLY - Managed by the operator)
# ============================================================================
# The status section is automatically updated by the operator
# DO NOT include this in your YAML when creating resources
#
# status:
#   conditions:
#     - type: Ready
#       status: "True"
#       lastTransitionTime: "2024-01-15T10:30:00Z"
#       reason: Synced
#       message: "Alert template synchronized with OpenObserve"
#   lastSyncTime: "2024-01-15T10:30:00Z"
#   observedGeneration: 1

# ============================================================================
# VALIDATION RULES SUMMARY
# ============================================================================
# 1. Name Validation:
#    - Required field
#    - Must match pattern: ^[a-zA-Z0-9_-]+$
#    - Maximum 255 characters
#    - Must be unique within the organization
#
# 2. Title Validation:
#    - Required field
#    - Maximum 500 characters
#
# 3. Body Validation:
#    - Required field
#    - No length limit
#    - Format should match the template type
#
# 4. Type Validation:
#    - Required field
#    - Must be exactly "http" or "email"
#
# 5. Organization:
#    - Optional field
#    - Must exist in OpenObserve if specified
#    - Defaults to organization from ConfigRef
#
# 6. ConfigRef:
#    - Required field
#    - Referenced OpenObserveConfig must exist
#    - Config must be in Ready state

# ============================================================================
# COMMON USE CASES
# ============================================================================
#
# 1. SLACK WEBHOOK:
#    - Use type: "http"
#    - Body should be Slack message format JSON
#    - Include attachments for rich formatting
#
# 2. PAGERDUTY:
#    - Use type: "http"
#    - Body should follow PagerDuty Events API v2 format
#    - Include routing_key, event_action, payload
#
# 3. EMAIL NOTIFICATION:
#    - Use type: "email"
#    - Body can be HTML or plain text
#    - Title becomes the email subject
#
# 4. CUSTOM WEBHOOK:
#    - Use type: "http"
#    - Body format depends on your endpoint requirements
#    - Can be JSON, XML, or any text format

# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# Error: "Invalid alert template type 'slack'"
# Solution: Use type: "http" instead, with Slack-formatted JSON body
#
# Error: "Alert template name cannot exceed 255 characters"
# Solution: Shorten the name field in spec
#
# Error: "Alert template with name 'X' already exists"
# Solution: Use a unique name or update the existing template
#
# Error: "Failed to resolve organization"
# Solution: Verify the organization exists in OpenObserve
#
# Error: "OpenObserveConfig 'X' is not ready"
# Solution: Check the status of your OpenObserveConfig resource

# ============================================================================
# BEST PRACTICES
# ============================================================================
#
# 1. Use descriptive names that include version (e.g., "prod-critical-v1")
# 2. Keep templates generic and reusable across multiple alerts
# 3. Use template variables instead of hardcoding values
# 4. Test templates with sample data before deploying to production
# 5. Version your templates when making significant changes
# 6. Document custom variables in comments
# 7. Use consistent naming conventions across templates
# 8. Group related templates in the same namespace
# 9. Use labels to organize templates by environment or team
# 10. Keep email templates responsive for mobile devices